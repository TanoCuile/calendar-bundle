function initializeBaseCalendar(a){a.BaseCalendarView=Backbone.View.extend({bind:null,loadNotesUrl:"/api/calendar/order/load",$datepicker:null,showNotes:[],daysFull:{1:"понедельник",2:"вторник",3:"среда",4:"четверг",5:"пятница",6:"субота",0:"воскесение"},days:{1:"пн",2:"вт",3:"ср",4:"чт",5:"пт",6:"сб",0:"вс"},months:{1:"января",2:"февраля",3:"марта",4:"апреля",5:"мая",6:"июня",7:"июля",8:"августа",9:"сентября",10:"октября",11:"ноября",12:"декабря"},options:{},defaults:{odd:false,hidden:true,reload:true,date:null,rows:null,times:null,dateStr:"",columns:null,buSite:true,markAbility:false,calendarOptions:{workGridStart:"start60",calendarHeight:0,height:0}},addDays:function(b,e){var g=b.getTimezoneOffset()*60*1000,c=b.getTime(),i=new Date(),f;c+=(1000*60*60*24)*e;i.setTime(c);f=i.getTimezoneOffset()*60*1000;if(g!=f){var h=f-g;c+=h;i.setTime(c)}return i},getWeekDays:function(d){var c=d.getDay();var f=[];var b=0;for(var e=c*-1;e<7-c;++e){f.push({day:this.addDays(d,e+1),day_id:b});b++}return f},getWorkDay:function(b){return this.options.data.get("schedule").get("workDays")[(b.getDay()>0)?(b.getDay()-1):6]},initialize:function(b){if(b.error){MainElements.messageManager.showMessage(b.error)}else{this.options=_.extend(this.defaults,this.options,b);this.options.data=new a.DayCalendarInfo(_.extend(b,{categories:this.options.categories}));this.options.view=this;this.options.rows=[];this.options.times=[];this.options.columns=[];this.proposes=b.proposes;if(!this.options.date){this.options.date=new Date()}this.customInitialize(b);this.initializeColumns();this.initializeDatePicker();this.changeDate(this.options.date);this.bind=rivets.bind(this.el,this.options);this.$el.removeClass("hidden")}},getColumnView:function(d,e,c){var b=null;_.each(this.options.columns,function(f){if(f.view.model.get("id")==d&&f.view.model.get("category")==e){b=f.view;return{}}});return b},activateAll:function(b,c){},customInitialize:function(b){},updateScrollBar:function(){console.log("this",this.options.data.get("weekCalendar"),this.weekCalendar.scrollPane,this.dayCalendar.scrollPane);if(this.weekCalendar.scrollPane&&this.options.data.get("weekCalendar")){this.weekCalendar.scrollPane.find(".mCSB_container").css("width",865);this.weekCalendar.scrollPane.mCustomScrollbar("update")}else{if(this.dayCalendar.scrollPane){this.dayCalendar.scrollPane.find(".mCSB_container").css("width",865);this.dayCalendar.scrollPane.mCustomScrollbar("update")}}},changeDate:function(b){var c=this.options.data.get("schedule").get("workDays")[(b.getDay()>0)?(b.getDay()-1):6];this.options.date=b;if(c.get("active")&&this.options.data.get("schedule").checkSupply(b)){this.options.reload=true;this.dateStrGenerate();this.options.data.set("currentDay",c);this.initializeRows();this.heightAlgorithm(this);this.loadNotes();this.trigger("change:date",this);this.options.reload=true;this.options.hidden=false}else{MainElements.messageManager.showMessage("Сегодня ("+this.days[b.getDay()]+") вы не работаете.",10000);this.options.hidden=true}},heightAlgorithm:function(b){b.options.calendarOptions.height=b.options.rows.length*b.options.data.get("cellHeight")+2;b.options.calendarOptions.calendarHeight=b.options.calendarOptions.height+75},initializeRows:function(){_.each(this.options.rows,function(){this.options.rows.pop()}.bind(this));_.each(this.options.times,function(){this.options.times.pop()}.bind(this));var b=60;var d=this.options.data.get("currentDay").get("timeFrom");var n=this.options.data.get("currentDay").get("timeTo");if(this.fromTime){d=this.fromTime}if(this.toTime){n=this.toTime}if(d%60>0){b=60-(d%60)}this.options.calendarOptions.workGridStart="start"+b;for(var k=d;k<=n;){var e=Math.floor((k%60));var m=k+b;var h=15;if(m+e+15>n){h=n-(m+e+15)}for(var g=0;g<b;g+=h){var l=60-b;h=15;var o={timeShow:false};o.id=(k+g);var f=(Math.floor(k/60));if(f%2==0){o.odd=true}o.time=(f<10?"0"+f:f)+":"+(l+g>10?l+g:"00");if(g==0){o.timeShow=true;this.options.times.push({timeSize:b,time:o.time});o.timeSize=b;o.first=true}else{if(g==b-15){o.last=true}else{o.empty=true}}this.options.rows.push(o)}k+=b;b=60;if(k+b>n){b=n-k}if(k==n){break}}if(this.$calendar){this.$calendar.find(".work-field .workDaysmaster").css("height",this.options.columnHeight)}else{this.options.workColumnStyle+="height:"+this.options.columnHeight+"px;"}},initializeBuffers:function(){var b=new Date();_.each(this.data.get("activeMasters"),function(d){if(!d.get("bufferElements")){d.set("bufferElements",[])}else{_.each(d.get("bufferElements"),function(){d.get("bufferElements").pop()}.bind(this))}var f=null;if(f=d.get("schedule")){var c=null;if(c=f.workDays[b.getDay()]){if(c.fromTime>this.options.fromTime){this.createBufferElement(d,c.fromTime-this.options.fromTime,0)}if(c.timeTo<this.options.toTime){var e=this.options.toTime-c.timeTo;this.createBufferElement(d,e,this.options.toTime-e-this.options.timeFrom)}}}}.bind(this))},createBufferElement:function(b,d,c){b.get("bufferElements").push(new a.BufferView({start:c/15*12,diff:d/15*12}))},zebra:function(){return function(b,c){this.model.odd=!this.model.odd;if(!this.model.odd){$(b).addClass("odd")}}},createNote:function(e,d,g,f,i,h,c,j,b){if(!h){h=false}if(!b){b={}}return new a.OrderNote(_.extend({date:e,timeFrom:d,toTime:g,service:(i&&i.id?i.id:i),editable:h||c,owner:f,"new":h,edit:h||j||this.options.showNotes.indexOf(b.id),checkType:false,oneMaster:false},b))},loadNotes:function(){var b={};_.each(this.options.columns,function(c){b[c.view.model.get("id")]=c.view.model;c.view.clear()});$.ajax({url:this.loadNotesUrl,type:"POST",data:{date:{d:this.options.date.getDate(),m:this.options.date.getMonth()+1,y:this.options.date.getFullYear()},dateTo:{},masters:_.keys(b)}}).success(function(c){if(c.status==1){_.each(c.notes,function(d,f){var e=this.createNoteModel(this.options.date,d.timeFrom,d.toTime,b[d.owner.id],d.service,false,false,false,d);this.getColumnView(d.owner.id,d.category).initializeAddNoteView(e)}.bind(this))}}.bind(this))},initializeTable:function(){var b=this;return function(c,d){$(c).hover(function(e){d.markAbility=true}.bind(this),function(e){d.markAbility=false}.bind(this))}},checkNextActiveDay:function(b){var c=this.getWorkDay(b);if(!c.get("active")||!this.options.data.get("schedule").checkSupply(b)){b.setTime(b.getTime()+24*3600);c=this.checkNextActiveDay(b)}return c},checkPrevActiveDay:function(b){var c=this.getWorkDay(b);if(!c.get("active")||!this.options.data.get("schedule").checkSupply(b)){b.setTime(b.getTime()-24*3600);c=this.checkPrevActiveDay(b)}return c},createNoteModel:function(e,d,g,f,i,h,c,j,b){if(!h){h=false}if(!b){b={}}return new a.OrderNote(_.extend({date:e,fromTime:d,toTime:g,service:(i&&i.id?i.id:i),editable:h||c,owner:f,"new":h,edit:h||j,checkType:false,oneMaster:false},b))},dateStrGenerate:function(){this.options.dateStr=this.options.date.getDate()+" "+this.months[(this.options.date.getMonth()+1)]+", "+this.days[this.options.date.getDay()]},loadPrev:function(c,b){b.date.setTime(b.date.getTime()-24*3600);console.log("Test",b.date.getDate());b.view.checkPrevActiveDay(b.date);b.view.changeDate(b.date)},loadCurrent:function(c,b){b.view.changeDate(b.date)},loadNext:function(c,b){b.date.setTime(b.date.getTime()+24*3600);b.view.checkNextActiveDay(b.date);b.view.changeDate(b.date)},initializeDatePicker:function(){var b=this;this.$el.find(".datepicker-icon input").datepicker({defaultDate:this.date,showOtherMonths:true,firstDay:1,onSelect:function(d,c){b.options.date.setDate(c.selectedDay);b.options.date.setMonth(c.selectedMonth);b.options.date.setYear(c.selectedYear);b.changeDate(b.options.date)},beforeShowDay:b.checkDatePickerDay.bind(b)});this.$datepicker=this.$el.find(".datepicker-icon input");this.$datepicker.datepicker("hide")},checkDatePickerDay:function(d){var c=0;var b=new Date();b.setDate(b.getDate()-1);if(!(d>=b)){return[false]}return[true]},messageTrigger:function(){var b=this.data.get("message");if(b.length>0){this.showMessage(b)}else{this.hideMessage()}},showMessage:function(d){var b=this;b.data.set("message",d);var c=this.$el.find(".message");c.fadeIn(400,function(){c.removeClass("hidden")})},hideMessage:function(){var b=this;var c=this.$el.find(".message");c.hide(400,function(){c.addClass("hidden");b.data.set("message",false)})},closeMessage:function(c,b){b.view.hideMessage()},showPicker:function(c,b){b.view.$datepicker.datepicker("show")}});rivets.binders["remove-drop"]=function(b,c){$(b).droppable({drop:function(h,k){var g=$(k.draggable).attr("data-note");var j=$(k.draggable).attr("data-column");var i=$(k.draggable).attr("data-category");var f=c.options.data.getColumn(j,i);var e=f.getNote(g);var d=c.getColumnView(j,i,e.get("date"));d.removeNoteView(e);d.removeNote(e);e.remove()}})}};