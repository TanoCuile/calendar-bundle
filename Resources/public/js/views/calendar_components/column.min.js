function initializeColumn(d){var c={validateNote:function(i,k,j,h,g,f){return d.OrderNote.validate(i.get("timeFrom"),i.get("timeTo"),i.get("notes"),k,k+j,h,g,f)},getNoteInfo:function(i,h,j,k){var g=null;if(i.model.get("id")==j&&i.model.get("category")==k){g=i.model.getNote(h)}else{var f=i.calendarInfo.getColumn(j,k);if(f){g=f.getNote(h)}else{console.error("Column not found",j,i)}}return g},getOnDragDistance:function(f){var g=f.pageY-$(f.target).offset().top;return g},getDistance:function(f){if(f.gesture){return f.gesture.center.y}var g=f.offsetY||f.pageY-$(f.target).offset().top;if(f.target.tagName=="DIV"){g=$(f.target).position().top+g}return g},onDrag:function(k,i,s){function j(w,v){return function(y,z){var x=z.column.calendarView.getColumnView(w.get("id"),z.categoryId,z.dayId);if(x){y.manipulateEement(function(A){A.css("left",0)});x.removeNoteView(v);x.removeNote(v);y.model.set("owner",{id:k.view.model.get("id")});if(z.date&&z.date.day){y.model.set("date",z.date.day)}z.column.removeFromGrid(v);k.view.initializeAddNoteView(v,y);u(y,z);y.calculateOffsetTop();k.view.recalculateElement(y);if(!v.get("new")){v.save()}}}}function m(v){var w=0;if(!v.calendarView.fromTime){w=v.calendarInfo.get("currentDay").get("fromTime")}else{w=v.calendarView.fromTime}if(w<v.model.get("timeFrom")){w=v.model.get("timeFrom")}return w}function u(v,w){var x=m(w.column);v.calculateTime(w.top,x)}function q(){return function(v,w){u(v,w);v.calculateOffsetTop();v.manipulateEement(function(x){x.css("left",0)});w.column.recalculateElement(v);w.column.checkNoteOffsets(v.model);if(!n.get("new")){v.model.save()}}}function t(v,z,x,w){var y=m(v);return d.ColumnView.validateNote(v.model,y+d.ColumnInfo.pixelsToTime(z),x.get("duration"),x.get("id"),w,x.get("propose"))}var g=$(s.draggable).attr("data-note");var h=$(s.draggable).attr("data-column");var o=$(s.draggable).attr("data-day-id");var l=$(s.draggable).attr("data-category");var n=null;var p=null;if(k.view.model.get("id")==h&&((o&&k.workDay==o)||(l&&k.view.model.get("category")==l))){n=k.view.model.getNote(g)}else{p=k.view.calendarInfo.getColumn(h,l,o);if(p){n=p.getNote(g)}else{console.error("Column not found",h,k.view)}}if(n){var r=s.position.top-k.view.grid.topBuffer.duration;n.onDragStopParameters={categoryId:l,column:k.view,dayId:o,date:k.date,top:r,currentColumn:p};var f=false;if(p){if(t(p,r,n,k.date)){f=true;n.onDragStop=j(p,n)}}else{if(t(k.view,r,n,k.date)){f=true;n.onDragStop=q()}}if(!f){e(s.draggable);return false}return true}else{e(s.draggable);return false}}};var a={calendarInfo:null,calendarView:null,buffers:null,regions:null,notes:null,defaultDuration:60,height:0,grid:null,interfaces:null,openedPopupsCount:0,initialize:function(f){this.interfaces=[];this.grid={};this.notes=[];this.buffers=[];this.regions=[];this.calendarInfo=f.baseInfo;this.calendarView=f.calendarView;if(f.date){this.date=f.date}else{this.date=this.calendarView.options.date}this.model=f.model;if(!f.autoCalculate){this.calendarInfo.on("change:currentDay",this.changeCurrentDay.bind(this))}},getDefaultDuration:function(f){return f.column.view.defaultDuration?f.column.view.defaultDuration:60},changeCurrentDay:function(){if(this.calendarView.calculateBuffers){this.calendarView.calculateBuffers(this.calculateBuffers.bind(this),this)}else{this.calculateBuffers()}},calculateNoteOffset:function(j){var f=j.model.get("fromTime");var g=f+j.model.get("duration");var i=false;var h=false;_.each(this.notes,function(k){if(j.model.get("id")!=k.model.get("id")){var m=k.model.get("fromTime");var l=m+k.model.get("duration");if(m<g){h=true}if(f>l){i=true}}});j.offsetBottom=h;j.offsetTop=i},drag:function(f,g,h){d.ColumnView.onDrag(f,g,h)},recalculateElement:function(g){var f=this.grid;if(f[g.model.get("id")]){f[g.model.get("id")]["duration"]=g.model.get("duration");f[g.model.get("id")]["top"]=g.topOffset}},addToGrid:function(f){this.grid[f.model.get("id")]={top:f.topOffset,duration:f.model.get("duration")}},removeFromGrid:function(f){delete this.grid[f.get("id")]},checkGrid:function(g,h){var f=true;_.each(this.grid,function(i){if((g<i.top&&i.top<g+h-18)){f=false;return{}}});return f},initializeAddNoteView:function(f,g){this.model.get("notes").push(f);if(!g){g=new d.NoteView({model:f,columnData:this.model,calendarData:this.calendarInfo,columnView:this})}f.view=g;this.checkNoteOffsets(g.model);this.addToGrid(g);this.notes.push(g);f.on("change:edit",this.checkPopup.bind(this));f.on("change:showInfo",this.checkPopup.bind(this));return g},checkPopup:function(g,f){if(f){this.openedPopupsCount++;if(this.openedPopupsCount>1){_.each(this.notes,function(h){if(h&&g.get("id")!=h.model.get("id")){if(h.model.get("showInfo")){h.model.set("showInfo",false)}else{if(h.model.get("edit")){if(h.model.get("new")){h.model.set("edit",false);h.model.set("showPopup",false);this.removeNoteView(h.model);this.removeNote(h.model);h.model.remove()}else{h.model.set("edit",false)}}else{console.error("IMPOSIBLE POPUP",h)}}}}.bind(this))}}else{this.openedPopupsCount--}this.calendarView.updateScrollBar()},initializeNote:function(h,g){if(d.ColumnView.validateNote(this.model,h,g,null,this.date)){var f=new d.OrderNote({date:this.date,edit:true,"new":true,fromTime:h,duration:g,bySite:this.calendarView.options.bySite,owner:{id:this.model.get("id")}});this.model.get("notes").push(f);return this.initializeAddNoteView(f)}},initializeDefaultNote:function(g){var f=this.defaultDuration;return this.initializeNote(g,f)},calculateTimeOffset:function(f,g){if(!f.view.fromTime){return f.data.get("currentDay").get("fromTime")+g-g%15}else{return f.view.fromTime+g-g%15}},addNote:function(i,g){i.preventDefault(true);i.stopPropagation(true);console.log("ADDNOTE",i);var j=d.ColumnInfo.pixelsToTime(d.ColumnView.getDistance(i));var h=g.column.view.calculateTimeOffset(g,j);var f=g.column.view.initializeDefaultNote(h);if(f){g.column.showPopup=true;g.column.view.openedPopupsCount++;g.column.view.checkPopup(f.model,true)}},checkNoteOffsets:function(i){var f=i.get("fromTime");var h=f+i.get("duration");var g=false;var j=false;_.each(this.notes,function(l){var k=l.model.get("fromTime")+l.model.get("duration");if(f<l.model.get("fromTime")&&h>l.model.get("fromTime")){j=true}if(h>k&&f<k){g=true}});i.set("reserveStart",g);i.set("reserveEnd",j)},stopPropagation:function(f){f.preventDefault(true);f.stopPropagation(true)},getNote:function(g){var f=null;_.each(this.notes,function(h){if(h.model.get("id")==g){f=h;return{}}});return f},removeNoteView:function(f){_.each(this.notes,function(g,h){if(g&&g.model.get("id")==f.get("id")){this.notes.splice(h,1);return{}}}.bind(this))},removeNote:function(f){_.each(this.model.get("notes"),function(g,h){if(g&&f.get("id")==g.get("id")){this.removeFromGrid(g);this.model.get("notes").splice(h,1);return{}}}.bind(this))}};a.createInterface=function(g,h,i){var f={markTop:0,showPopup:false,marker:false,date:h,workDay:g,view:this};if(i){f.category=i}this.interfaces.push(f);return f};a.clear=function(){if(this.notes.length>0){_.each(this.notes,function(f,g){if(typeof(f)=="object"){this.removeNote(f.model);this.notes.splice(g,1)}}.bind(this))}};a.getDayDate=function(g,h,f){var i=h.getDay();return f.setTime((h.getTime()-h.getTime()%3600*24)+(i-g)*24*3600)};a.regionLogic=function(){};a.calculateBuffers=function(h,f,j,i){_.each(this.buffers,function(){this.buffers.pop()}.bind(this));_.each(this.regions,function(){this.regions.pop()}.bind(this));delete this.grid.topBuffer;delete this.grid.bottomBuffer;this.date=new Date();if(!h){var g=this.model.get("schedule").get("workDays")[this.calendarInfo.get("currentDay").get("dayId")-1];this.getDayDate(this.calendarInfo.get("currentDay").get("dayId"),this.calendarView.options.date,this.date)}else{var g=this.model.get("schedule").get("workDays")[h-1];this.getDayDate(h,this.calendarView.options.date,this.date)}if(!f){f=this.calendarInfo.get("currentDay").get("timeFrom")}if(!j){j=this.calendarInfo.get("currentDay").get("timeTo")}if(g.get("active")&&this.calendarInfo.get("schedule").checkSupply(this.date)){if(f<g.get("timeFrom")){var l=d.ColumnInfo.timeToPixels(g.get("timeFrom")-f);this.buffers.push(this.initializeBuffer(0,l));this.model.set("timeFrom",g.get("timeFrom"));this.grid.topBuffer={top:0,duration:l}}else{this.grid.topBuffer={top:0,duration:0};this.model.set("timeFrom",f)}if(j>g.get("timeTo")){var l=d.ColumnInfo.timeToPixels(j-g.get("timeTo"));var k=d.ColumnInfo.timeToPixels(g.get("timeTo")-f);this.buffers.push(this.initializeBuffer(k,l));this.model.set("timeTo",g.get("timeTo"));this.grid.bottomBuffer={top:k,duration:l}}else{this.grid.bottomBuffer={top:d.ColumnInfo.timeToPixels(j-f),duration:0};this.model.set("timeTo",j)}if(this.interfaces.length==1||i){if(!i){i=this.interfaces[0]}i.show=true}}else{if(this.interfaces.length==1||i){if(!i){i=this.interfaces[0]}i.show=false}this.buffers.push(this.initializeBuffer(0,d.ColumnInfo.timeToPixels(j-f)))}if(this.model.get("proposes")){_.each(this.model.get("proposes"),function(m){var n=this.calendarView.proposes[m];if(this.checkProposeOnDay(n,g)){this.regions.push({height:d.ColumnInfo.timeToPixels(n.toTime-n.fromTime),start:d.ColumnInfo.timeToPixels(n.fromTime-f)})}}.bind(this))}};a.checkProposeOnDay=function(g,f){if(g.period_type===false){switch(g.applying_type){case 1:break;case 4:if(!f.get("weekend")){return false}console.log("Propose",g.period_type===false,g.name,g);break;case 5:if(f.get("weekend")){return false}break}}else{console.log("Propose",this.date.getTime()<g.fromDateTime,this.date.getTime(),g.toDateTime);if(this.date.getTime()<g.fromDateTime||this.date.getTime()>g.toDateTime){return false}}return true};a.initializeBuffer=function(g,f){return{start:g,height:f}};d.ColumnView=Backbone.View.extend(a,c);rivets.binders["silent-move"]=function(g,f){$(g).mousemove(function(h){});$(g).click(function(h){h.stopPropagation(true)});$(g).dblclick(function(h){h.stopPropagation(true)});$(g).hover(function(h){h.preventDefault(true);h.stopPropagation(true);f.calendarView.options.markAbility=false;_.each(f.calendarView.options.columns,function(i){i.mark=false})}.bind(this),function(h){h.preventDefault(true);h.stopPropagation(true);f.calendarView.options.markAbility=true}.bind(this))};rivets.binders["dropable-column"]=function(g,f){b.call(this,g,f);$(g).droppable({drop:function(h,i){f.view.drag(f,h,i)}})};function b(g,f){$(g).mousemove(function(h){if(!$(h.target).hasClass("note")){if(f.view.calendarView.options.markAbility){var i=d.ColumnView.getDistance(h);if(this.model.column.view.checkGrid(i,this.model.column.view.getDefaultDuration(this.model))&&i>2&&(i+this.model.column.view.getDefaultDuration(this.model))<($(g).height()+25)){if(!this.model.column.mark){this.model.column.mark=true}this.model.column.markTop=i-i%12}else{this.model.column.mark=false}}}}.bind(this));$(g).hover(function(h){h.preventDefault(true);this.model.column.mark=true;f.mark=true}.bind(this),function(h){h.preventDefault(true);this.model.column.mark=false}.bind(this))}var e=function(f){f.draggable({revert:true})}};