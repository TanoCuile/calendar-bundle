function initializeCalendar(a){a.CalendarWidgetView=Backbone.View.extend({rivets:null,$calendar:null,$header:null,$scrollPane:null,options:{},defaults:{popupHeight:220,heightAppend:49,widgetWidthOffset:70,headerHeight:48,show:false,rows:[],baseSchedule:{},cellHeight:12,fromTime:8*60,toTime:22*60,colWidth:220,columnStyle:"width:220px;",workColumnStyle:"width:220px;",dateStr:"",tableStyle:"300px;",date:new Date,columnHeight:0,onAddNote:false,editPopup:{editNote:false,activeNote:null,activeNoteView:null},noteSaveCallback:false,additionalDateCheck:false,afterMastersChange:false},widget:null,loadNotesUrl:"/api/calendar/order/load",days:{1:"понедельник",2:"вторник",3:"среда",4:"четверг",5:"пятница",6:"субота",0:"воскесение"},months:{1:"Января",2:"Февраля",3:"Марта",4:"Апреля",5:"Мая",6:"Июня",7:"Июля",8:"Августа",9:"Сентября",10:"Октября",11:"Ноября",12:"Декабря"},initialize:function(b){this.options=_.extend(this.defaults,b);this.data=b.data;this.data.on("change:activeMasters",this.changeMasters.bind(this));if(!this.data.get("notes")){this.data.set("notes",{})}this.changeMasters();this.options=_.extend(this.options,{view:this});this.rivets=rivets.bind(this.el,this.options);this.$header=this.$el.find(".calendar-header");this.$header.removeClass("hidden");this.initializeDatePicker();this.options.show=true;this.$calendar=this.$el.find(".calendar.field");this.$calendar.removeClass("hidden");var c=this.$calendar.find(".table").width();var d=this.$calendar.find(".calendar-widget");d.css("width",c-this.options.widgetWidthOffset);if(_.has(d,"jScrollPane")){d.jScrollPane();this.$scrollPane=d.data("jsp")}this.dateStrGenerate();this.data.on("change:message",this.messageTrigger.bind(this))},initializeDatePicker:function(){var b=this;this.$header.find(".datepicker input").datepicker({defaultDate:this.date,showOtherMonths:true,firstDay:1,onSelect:function(d,c){b.options.date.setDate(c.selectedDay);b.options.date.setMonth(c.selectedMonth);b.options.date.setYear(c.selectedYear);b.dateStrGenerate();b.loadNotes()},beforeShowDay:function(e){var d=0;var c=new Date();c.setDate(c.getDate()-1);if(!(e>=c)){return[false]}if(this.master){d=this.master.get("id")}if(b.options.additionalDateCheck){return b.options.additionalDateCheck(b,e)}return[false]}});this.$header.find(".datepicker").datepicker("hide")},showPicker:function(c,b){b.view.$header.find(".datepicker input").datepicker("show")},dateStrGenerate:function(){this.options.dateStr=this.options.date.getDate()+" "+this.months[(this.options.date.getMonth()+1)]+", "+this.days[this.options.date.getDay()]},loadPrev:function(c,b){b.date.setDate(b.date.getDate()-1);b.view.dateStrGenerate();b.view.loadNotes()},loadCurrent:function(c,b){b.view.loadNotes()},loadNext:function(c,b){b.date.setDate(b.date.getDate()+1);b.view.dateStrGenerate();b.view.loadNotes()},changeMasters:function(){this.onMastersChange();this.loadNotes()},changeMasterActive:function(){this.onMastersChange()},changeScheduleRows:function(){var c=-1;var b=-1;_.each(this.data.get("activeMasters"),function(e){if(e.get("notes").length==0&&this.data.get("notes")[e.get("id")]){_.after(this.data.get("notes")[e.get("id")],function(f){e.get("notes").push(f)})}else{if(!this.data.get("notes")[e.get("id")]){this.data.get("notes")[e.get("id")]=e.get("notes")}}if(e.get("schedule")&&e.get("active")){var d=null;if(d=e.get("schedule").workDays[this.options.date.getDay()]){if(c<0||c>d.timeFrom){c=d.timeFrom}if(b<0||b<d.timeTo){b=d.timeTo}e.set("inWork",true)}else{e.set("inWork",false)}}}.bind(this));if(c>0&&b>0){this.options.fromTime=c;this.options.toTime=b}else{this.options.fromTime=this.defaults.fromTime;this.options.toTime=this.defaults.toTime}this.initializeRows()},onMastersChange:function(){this.changeScheduleRows();var b=0;_.each(this.data.get("activeMasters"),function(c){if(c.get("active")&&c.get("inWork")){b+=1}});if(this.$calendar){this.$calendar.find(".calendar-field-wrapper").css("width",(b*this.options.colWidth+1));this.$calendar.find(".calendar-widget").css("height",this.options.columnHeight+this.options.heightAppend);this.$calendar.find(".calendar-field-wrapper").css("min-height",this.options.columnHeight)}if(this.$scrollPane){this.$scrollPane.reinitialise({height:this.options.columnHeight+this.options.headerHeight})}if(this.options.afterMastersChange){this.options.afterMastersChange.call(this)}},initializeRows:function(){_.each(this.options.rows,function(){this.options.rows.pop()}.bind(this));var d=60;if(this.options.fromTime%60>0){d=60-(this.options.fromTime%60)}for(var f=this.options.fromTime;f<=this.options.toTime;){var k=Math.floor((f%60));var h=f+d;var b=15;if(h+k+15>this.options.toTime){b=this.options.toTime-(h+k+15)}for(var e=0;e<d;e+=b){b=15;var g={timeShow:false};g.id=(f+e);if(e==0){g.timeShow=true;g.time=(Math.floor(f/60))+":"+(k>10?k:"00");g.timeSize=d}else{if(e==d-15){g.last=true}else{g.empty=true}}this.options.rows.push(g)}f+=d;d=60;if(f+d>this.options.toTime){d=this.options.toTime-f}if(f==this.options.toTime){break}}this.options.columnHeight=this.options.rows.length*this.options.cellHeight;if(this.$calendar){this.$calendar.find(".work-field .master").css("height",this.options.columnHeight)}else{this.options.workColumnStyle+="height:"+this.options.columnHeight+"px;"}this.initializeBuffers()},initializeBuffers:function(){var b=new Date();_.each(this.data.get("activeMasters"),function(d){if(!d.get("bufferElements")){d.set("bufferElements",[])}else{_.each(d.get("bufferElements"),function(){d.get("bufferElements").pop()}.bind(this))}var f=null;if(f=d.get("schedule")){var c=null;if(c=f.workDays[b.getDay()]){if(c.timeFrom>this.options.fromTime){this.createBufferElement(d,c.timeFrom-this.options.fromTime,0)}if(c.timeTo<this.options.toTime){var e=this.options.toTime-c.timeTo;this.createBufferElement(d,e,this.options.toTime-e-this.options.fromTime)}}}}.bind(this))},createBufferElement:function(b,d,c){b.get("bufferElements").push(new a.BufferView({start:c/15*12,diff:d/15*12}))},getValidateData:function(c,d){var f=c.toTime;var g=c.fromTime;var b=new Date();if(d){var e=d.get("schedule").workDays[b.getDay()];if(e&&f>e.timeTo){f=e.timeTo}if(e&&g<e.timeFrom){g=e.timeFrom}}return{toTime:f,fromTime:g}},validateNote:function(b,g,e,f,d){var c=this.getValidateData(b.options,e);var h=c.toTime;var i=c.fromTime;if(g.validate(i,h,e.get("notes"))){f(g,e,b)}else{if(d){d(g,e,b)}}},createNoteView:function(b,d,c){return new a.NoteView({calendar:b,model:d,fromTime:c.fromTime,toTime:c.toTime,popupHeight:c.popupHeight})},initializeNote:function(k,d,g,f,j,h,c,l,b){if(!c){c=false}if(!l){l=false}var i=k.createNote(k.options.date,d,g,f,j,h,c,l,b);var e=function(q,p,m){p.get("notes").push(q);var o=m.options;var n=m.createNoteView(m,q,o);p.get("noteViews").push(n);if(m.options.onAddNote){m.options.onAddNote(n,m)}}.bind(this);k.validateNote(k,i,f,e)},addNote:function(h,d){h.preventDefault(true);var c=null;if((c=d.data.get("activeJob"))&&!d.data.get("onEdit")){var b=parseInt($(h.target).attr("data-master"));var g=0;if(g=d.data.get("activeDurations")[b]){_.each(d.view.data.get("activeMasters"),function(e){if(e.get("id")==b){b=e;return{}}});var i=h.offsetY/12*15;var f=d.fromTime+i-i%15;d.view.initializeNote(d.view,f,f+g,b,c,true)}}},createNote:function(e,d,g,f,i,h,c,j,b){if(!h){h=false}if(!b){b={}}return new a.OrderNote(_.extend({date:e,fromTime:d,toTime:g,service:(i&&i.id?i.id:i),editable:h||c,owner:f,"new":h,edit:h||j,checkType:false,oneMaster:false},b))},bufferClick:function(b){b.preventDefault(true);b.stopPropagation()},loadNotes:function(){var b=[];_.each(this.data.get("activeMasters"),function(c){b.push(c.get("id"))});$.ajax({url:this.loadNotesUrl,type:"POST",data:{date:{d:this.options.date.getDate(),m:this.options.date.getMonth()+1,y:this.options.date.getFullYear()},masters:b}}).success(function(c){if(c.status==1){this.clearNotes();_.each(c.notes,function(d,e){this.initializeNote(this,d.fromTime,d.toTime,this.options.data.getMaster(d.owner.id),d.service,false,false,false,d)}.bind(this))}this.onMastersChange()}.bind(this))},clearNotes:function(){_.each(this.data.get("activeMasters"),function(b){_.each(b.get("notes"),function(){b.get("notes").pop();b.get("noteViews").pop()})})},getNoteData:function(h,k,l){var c=parseInt(h.attr("data-master"));var e=null;var j=parseInt(k.attr("data-master"));var b=k.attr("data-note");var g=null;_.each(l.data.get("activeMasters"),function(m){if(m.get("id")==c){e=m}if(m.get("id")==j){g=m}});var i=null;var f=l.data.get("activeDurations")[c];_.each(l.data.get("notes")[j],function(m){if(m&&m.get("id")==b){i=m;return{}}});if(!i){_.each(l.data.get("notes")[c],function(m){if(m&&m.get("id")==b){i=m;return{}}})}var d=l.fromTime+parseInt(k.css("top"))/12*15;if(i){if(!f){f=i.get("duration")}if(i.get("reserveStart")){d+=15}}else{}return{masterId:c,master:e,currentMasterId:j,duration:f,note:i,noteFromTime:d,currentMaster:g}},getDroppableOptions:function(){var c=this.options;var b=this;return{accept:function(h){var k=$(this);var q=$(h);var j=b.getNoteData(k,q,c);var e=j.masterId;var g=j.master;var p=j.currentMasterId;var i=j.duration;var n=j.note;var f=j.noteFromTime;if(!g){return false}var m=b.getValidateData(c,g);var l=m.toTime;var o=m.fromTime;if(!n){}if(i&&n){var d=a.OrderNote.validate(o,l,g.get("notes"),f,f+i,n.get("id"),n.get("oneMaster"),p);return d}return false},drop:function(i,h){var d=$(i.target);var j=$(h.draggable[0]);var g=b.getNoteData(d,j,c);var f=g.noteFromTime+g.duration;if(g.duration&&g.note){g.note.set("fromTime",g.noteFromTime);g.note.set("toTime",f);if(g.currentMasterId!=g.masterId){g.master.get("notes").push(g.note);g.note.set("owner",g.master);_.each(g.currentMaster.get("notes"),function(e,k){if(e&&e.get("id")==g.note.get("id")){g.currentMaster.get("notes").splice(k,1)}});_.each(g.currentMaster.get("noteViews"),function(e,k){if(e&&e.model.get("id")==g.note.get("id")){g.master.get("noteViews").push(b.createNoteView(b,g.note,c));g.currentMaster.get("noteViews").splice(k,1)}})}}}}},messageTrigger:function(){var b=this.data.get("message");if(b.length>0){this.showMessage(b)}else{this.hideMessage()}},showMessage:function(d){var b=this;b.data.set("message",d);var c=this.$el.find(".message");c.fadeIn(400,function(){c.removeClass("hidden")})},hideMessage:function(){var b=this;var c=this.$el.find(".message");c.hide(400,function(){c.addClass("hidden");b.data.set("message",false)})},closeMessage:function(c,b){b.view.hideMessage()}},{})};